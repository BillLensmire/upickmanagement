{% extends 'base.html' %}

{% with page_app='planning' page_name='garden_plan' page_action='form' %}
{% block title %}{% if garden_plan %}Edit{% else %}Create{% endif %} Garden Plan - You Pick Manager{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'planning:garden_plan_list' %}">Garden Plans</a></li>
            <li class="breadcrumb-item active">{% if garden_plan %}Edit{% else %}Create{% endif %} Garden Plan</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% if garden_plan %}Edit{% else %}Create{% endif %} Garden Plan</h5>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">Please correct the following errors:</h5>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                <li>{{ field|title }}: {{ errors|join:', ' }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                                   id="name" name="name" value="{{ form.name.value|default:'' }}" required>
                            <div class="invalid-feedback">
                                {% if form.name.errors %}
                                    {{ form.name.errors|join:', ' }}
                                {% else %}
                                    Please enter a name for the garden plan.
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="year" class="form-label">Year</label>
                            <input type="number" class="form-control {% if form.year.errors %}is-invalid{% endif %}" 
                                   id="year" name="year" value="{{ form.year.value|default:'' }}" 
                                   min="2000" max="2100" required>
                            <div class="invalid-feedback">
                                {% if form.year.errors %}
                                    {{ form.year.errors|join:', ' }}
                                {% else %}
                                    Please enter a valid year (2000-2100).
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control {% if form.start_date.errors %}is-invalid{% endif %}" 
                                   id="start_date" name="start_date" value="{% if garden_plan.start_date %}{{ garden_plan.start_date|date:'Y-m-d' }}{% endif %}">
                            <div class="invalid-feedback">
                                {% if form.start_date.errors %}
                                    {{ form.start_date.errors|join:', ' }}
                                {% else %}
                                    Please select a start date.
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control {% if form.end_date.errors %}is-invalid{% endif %}" 
                                   id="end_date" name="end_date" value="{% if garden_plan.end_date %}{{ garden_plan.end_date|date:'Y-m-d' }}{% endif %}">
                            <div class="invalid-feedback">
                                {% if form.end_date.errors %}
                                    {{ form.end_date.errors|join:', ' }}
                                {% else %}
                                    Please select an end date.
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}" 
                                      id="description" name="description" rows="3">{{ form.description.value|default:'' }}</textarea>
                            {% if form.description.errors %}
                            <div class="invalid-feedback">{{ form.description.errors|join:', ' }}</div>
                            {% else %}
                            <div class="form-text">Optional: Add any additional details about this garden plan.</div>
                            {% endif %}
                        </div>

                        <div class="text-end mt-4">
                            <a href="{% url 'planning:garden_plan_list' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                {% if garden_plan %}Save Changes{% else %}Create Garden Plan{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set min date for end date based on start date
    document.getElementById('start_date').addEventListener('change', function() {
        document.getElementById('end_date').min = this.value;
    });

    // Set max date for start date based on end date
    document.getElementById('end_date').addEventListener('change', function() {
        document.getElementById('start_date').max = this.value;
    });
document.addEventListener('DOMContentLoaded', function() {
    // Initialize datepickers
    $('.datepicker').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true,
        clearBtn: true
    });

    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Ensure end date is after start date
    $('#start_date').on('changeDate', function(e) {
        $('#end_date').datepicker('setStartDate', e.date);
    });

    $('#end_date').on('changeDate', function(e) {
        $('#start_date').datepicker('setEndDate', e.date);
    });
});
</script>
{% endblock %}
{% endwith %}
