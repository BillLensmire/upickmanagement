{% extends 'base.html' %}
{% load static %}
{% with page_app='schedule' page_name='schedule' page_action='form' %}
{% block title %}{% if schedule %}Edit{% else %}Create{% endif %} Schedule - Garden Planner{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'schedule:list' %}">Schedule</a></li>
            <li class="breadcrumb-item active">{% if schedule %}Edit{% else %}Create{% endif %} Schedule</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% if schedule %}Edit{% else %}Create{% endif %} Planting Schedule</h5>
                </div>
                <div class="card-body">
                    {% if form.errors %}
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading">Please correct the following errors:</h5>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items %}
                                {% if field == '__all__' %}
                                    {% for error in errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% else %}
                                    <li><strong>{{ field|title }}:</strong> {{ errors|join:', ' }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        {% if selected_year %}
                        <input type="hidden" name="selected_year" value="{{ selected_year }}">
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="garden_plan" class="form-label">Garden Plan Year</label>
                            <select name="garden_plan" id="garden_plan" class="form-select" required>
                                <option value="">Select a Garden Plan</option>
                                {% for plan in garden_plans %}
                                <option value="{{ plan.id }}" {% if form.garden_plan.value == plan.id|stringformat:'i' %}selected{% elif schedule and schedule.garden_plan.id == plan.id %}selected{% endif %}>
                                    {{ plan.name }} ({{ plan.year }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a garden plan.</div>
                        </div>

                        <div class="mb-3">
                            <label for="garden_bed" class="form-label">Garden Bed</label>
                            <select name="garden_bed" id="garden_bed" class="form-select" required>
                                <option value="">Select a Garden Bed</option>
                                {% for bed in garden_beds %}
                                <option value="{{ bed.id }}" {% if form.garden_bed.value == bed.id|stringformat:'i' %}selected{% elif schedule and schedule.garden_bed.id == bed.id %}selected{% endif %}>
                                    {{ bed.name }} ({{ bed.width_feet }}' x {{ bed.length_feet }}')
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a garden bed.</div>
                            {% if selected_year %}
                            <small class="text-muted">Showing garden beds for year {{ selected_year }}</small>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="variety" class="form-label">Variety</label>
                            <select name="variety" id="variety" class="form-select" required>
                                <option value="">Select a Variety</option>
                                {% for variety in varieties %}
                                <option value="{{ variety.id }}" {% if form.variety.value == variety.id|stringformat:'i' %}selected{% elif schedule and schedule.variety.id == variety.id %}selected{% endif %}>
                                    {% if variety.variety_plant %}{{ variety.variety_plant.name }} - {% endif %}{{ variety.variety_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a variety.</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" 
                                           value="{% if form.quantity.value %}{{ form.quantity.value }}{% elif schedule %}{{ schedule.quantity }}{% else %}1{% endif %}" min="1" required>
                                    <div class="invalid-feedback">Please enter a valid quantity.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="rows" class="form-label">Number of Rows</label>
                                    <input type="number" class="form-control" id="rows" name="rows" 
                                           value="{% if form.rows.value %}{{ form.rows.value }}{% elif schedule %}{{ schedule.rows }}{% else %}1{% endif %}" min="1"
                                           required>
                                    <div class="invalid-feedback">Please enter a valid number of rows.</div>
                                </div>
                            </div>
                        </div>

                        {% if schedule %}
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" id="status" class="form-select" required>
                                {% for status_code, status_label in status_choices %}
                                <option value="{{ status_code }}" {% if form.status.value == status_code %}selected{% elif status_code == schedule.status %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="row" id="variety-info-row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="days_to_germinate" class="form-label">Days to Germinate</label>
                                    <div id="days-to-germinate">{% if schedule and schedule.variety %}{{ schedule.variety.variety_days_to_germinate|default:"--" }}{% else %}--{% endif %}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="days_from_seed_to_transplant" class="form-label">Days Seed to Transplant</label>
                                    <div id="days-from-seed-to-transplant">{% if schedule and schedule.variety %}{{ schedule.variety.variety_days_from_seed_to_transplant|default:"--" }}{% else %}--{% endif %}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="days_to_maturity" class="form-label">Days to Maturity</label>
                                    <div id="days-to-maturity">{% if schedule and schedule.variety %}{{ schedule.variety.variety_days_to_maturity|default:"--" }}{% else %}--{% endif %}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="days_from_frost_to_transplant" class="form-label">Days Frost to Transplant</label>
                                    <div id="days-from-frost-to-transplant">{% if schedule and schedule.variety %}{{ schedule.variety.variety_days_from_frost_to_transplant|default:"--" }}{% else %}--{% endif %}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="inside_planting_date" class="form-label">Inside Planting Date</label>
                                    <input type="text" class="form-control datepicker" id="inside_planting_date" 
                                           name="inside_planting_date" value="{% if form.inside_planting_date.value %}{{ form.inside_planting_date.value|date:'m/d/Y' }}{% elif schedule.inside_planting_date %}{{ schedule.inside_planting_date|date:'m/d/Y' }}{% endif %}" 
                                           placeholder="MM/DD/YYYY" autocomplete="off">
                                    <div class="form-text">Format: MM/DD/YYYY</div>
                                    <div class="invalid-feedback">Please enter a valid inside planting date.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="outside_planting_date" class="form-label">Outside Planting Date</label>
                                    <input type="text" class="form-control datepicker" id="outside_planting_date" 
                                           name="outside_planting_date" value="{% if form.outside_planting_date.value %}{{ form.outside_planting_date.value|date:'m/d/Y' }}{% elif schedule.outside_planting_date %}{{ schedule.outside_planting_date|date:'m/d/Y' }}{% endif %}" 
                                           placeholder="MM/DD/YYYY" autocomplete="off">
                                    <div class="form-text">Format: MM/DD/YYYY</div>
                                    <div class="invalid-feedback">Please enter a valid outside planting date.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="harvest_date" class="form-label">Expected Harvest Date</label>
                                    <input type="text" class="form-control datepicker" id="harvest_date" 
                                           name="harvest_date" value="{% if form.harvest_date.value %}{{ form.harvest_date.value|date:'m/d/Y' }}{% elif schedule.harvest_date %}{{ schedule.harvest_date|date:'m/d/Y' }}{% endif %}" 
                                           placeholder="MM/DD/YYYY" autocomplete="off">
                                    <div class="form-text">Format: MM/DD/YYYY</div>
                                    <div class="invalid-feedback">Please enter a valid harvest date.</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3">{% if form.notes.value %}{{ form.notes.value }}{% elif schedule.notes %}{{ schedule.notes }}{% else %}{{ schedule.notes|default:'' }}{% endif %}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="location_notes" class="form-label">Location Notes</label>
                            <textarea class="form-control" id="location_notes" name="location_notes" rows="2">{% if form.location_notes.value %}{{ form.location_notes.value }}{% elif schedule.location_notes %}{{ schedule.location_notes }}{% else %}{{ schedule.location_notes|default:'' }}{% endif %}</textarea>
                            <div class="form-text">Describe where in the bed this will be planted.</div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'schedule:list' %}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variety data for date calculations
const varietiesData = {{ varieties_data|safe }};
const gardenPlans = {{ garden_plans_json|safe }};
const allVarieties = {{ varieties_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Initialize jQuery datepickers
    $('.datepicker').datepicker({
        format: 'mm/dd/yyyy',
        autoclose: true,
        todayHighlight: true,
        clearBtn: true,
        orientation: 'bottom'
    });

    // Date handling
    const insideDateInput = document.getElementById('inside_planting_date');
    const outsideDateInput = document.getElementById('outside_planting_date');
    const harvestDateInput = document.getElementById('harvest_date');
    const varietySelect = document.getElementById('variety');
    const gardenPlanSelect = document.getElementById('garden_plan');

    function calculatePlantingDates(harvestDate, varietyId) {
        if (!harvestDate || !varietyId || !varietiesData[varietyId]) return;

        const variety = varietiesData[varietyId];
        const harvestDateObj = parseDate(harvestDate);
        if (!harvestDateObj) return;
        
        let outsideDateObj, insideDateObj;

        // Calculate outside planting date based on days to maturity
        if (variety.days_to_maturity) {
            outsideDateObj = new Date(harvestDateObj);
            outsideDateObj.setDate(harvestDateObj.getDate() - variety.days_to_maturity);
            outsideDateInput.value = formatDateToMMDDYYYY(outsideDateObj);
            // Refresh the datepicker to show the new date
            $(outsideDateInput).datepicker('update');
        }

        // For transplants, calculate inside planting date
        if (variety.planting_method === 'TRANSPLANT' && variety.days_from_seed_to_transplant && outsideDateObj) {
            insideDateObj = new Date(outsideDateObj);
            insideDateObj.setDate(outsideDateObj.getDate() - variety.days_from_seed_to_transplant);
            insideDateInput.value = formatDateToMMDDYYYY(insideDateObj);
            // Refresh the datepicker to show the new date
            $(insideDateInput).datepicker('update');
        }
    }
    
    // Helper function to parse MM/DD/YYYY date string to Date object
    function parseDate(dateString) {
        if (!dateString) return null;
        
        // Handle MM/DD/YYYY format
        const parts = dateString.split('/');
        if (parts.length === 3) {
            const month = parseInt(parts[0], 10) - 1; // Months are 0-indexed in JS
            const day = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }
        
        // Fallback to standard date parsing
        return new Date(dateString);
    }
    
    // Helper function to format Date object to MM/DD/YYYY string
    function formatDateToMMDDYYYY(date) {
        if (!date || isNaN(date.getTime())) return '';
        
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${month}/${day}/${year}`;
    }

    // Update dates when harvest date changes
    harvestDateInput.addEventListener('change', function() {
        const varietyId = varietySelect.value;
        if (varietyId) {
            calculatePlantingDates(this.value, varietyId);
        }
    });

    // Update dates when variety selection changes and harvest date is set
    varietySelect.addEventListener('change', function() {
        if (harvestDateInput.value) {
            calculatePlantingDates(harvestDateInput.value, this.value);
        }
        
        // Update variety information display
        updateVarietyInfo(this.value);
    });
    
    // Function to update variety information display
    function updateVarietyInfo(varietyId) {
        if (!varietyId) {
            document.getElementById('days-to-germinate').textContent = '--';
            document.getElementById('days-to-maturity').textContent = '--';
            document.getElementById('days-from-seed-to-transplant').textContent = '--';
            document.getElementById('days-from-frost-to-transplant').textContent = '--';
            return;
        }
        
        // Find the variety in the varieties list
        const variety = allVarieties.find(v => v.id == varietyId);
        if (!variety) return;
        
        // Get variety data from the varieties_data dictionary
        const varietyData = varietiesData[varietyId] || {};
        
        // Update the display fields
        document.getElementById('days-to-germinate').textContent = 
            varietyData.days_to_germinate || '--';
        document.getElementById('days-to-maturity').textContent = 
            varietyData.days_to_maturity || '--';
        document.getElementById('days-from-seed-to-transplant').textContent = 
            varietyData.days_from_seed_to_transplant || '--';
        document.getElementById('days-from-frost-to-transplant').textContent = 
            varietyData.days_from_frost_to_transplant || '--';
    }
    
    // Initialize variety info if a variety is already selected
    if (varietySelect.value) {
        updateVarietyInfo(varietySelect.value);
    }

    // Ensure logical date order
    $(insideDateInput).on('changeDate', function() {
        if (this.value) {
            const insideDate = parseDate(this.value);
            if (insideDate) {
                // Set minimum date for outside planting
                $(outsideDateInput).datepicker('setStartDate', insideDate);
            }
        }
    });

    $(outsideDateInput).on('changeDate', function() {
        if (this.value) {
            const outsideDate = parseDate(this.value);
            if (outsideDate) {
                // Set minimum date for harvest date
                $(harvestDateInput).datepicker('setStartDate', outsideDate);
                
                // Set maximum date for inside planting
                $(insideDateInput).datepicker('setEndDate', outsideDate);
            }
        }
    });

    $(harvestDateInput).on('changeDate', function() {
        if (this.value) {
            const harvestDate = parseDate(this.value);
            if (harvestDate) {
                // Set maximum date for outside planting
                $(outsideDateInput).datepicker('setEndDate', harvestDate);
                
                // Update planting dates based on harvest date
                const varietyId = varietySelect.value;
                if (varietyId) {
                    calculatePlantingDates(this.value, varietyId);
                }
            }
        }
    });
});
</script>
{% endblock %}
{% endwith %}
